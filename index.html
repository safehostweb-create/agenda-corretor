// CÓDIGO CORRETO E COMPLETO PARA O GOOGLE APPS SCRIPT
function doGet(e) {
  const action = e.parameter.action;
  let data;
  if (action === "getCorretores") {
    data = getSheetData("usuarios");
  } else if (action === "getImoveis") {
    data = getSheetData("imoveis");
  } else {
    data = {status: "error", message: "Ação GET inválida"};
  }
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*");
}

function doPost(e) {
  let responseData;
  try {
    const data = JSON.parse(e.postData.contents);
    if (data.type === "cadastro") {
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("usuarios");
      sheet.appendRow([ new Date(), data.nome, data.email, data.telefone, data.creci, data.senha ]);
      responseData = {status: "ok", message: "Usuário cadastrado"};
    } else if (data.type === "imovel") {
      const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("imoveis");
      const fotosString = JSON.stringify(data.fotos || []);
      sheet.appendRow([ new Date(), data.corretor, data.nome, data.preco, data.endereco, data.site, data.descricao, fotosString ]);
      responseData = {status: "ok", message: "Imóvel adicionado"};
    } else {
      responseData = {status: "error", message: "Tipo de POST inválido"};
    }
  } catch (error) {
    responseData = {status: "error", message: error.message};
  }
  return ContentService.createTextOutput(JSON.stringify(responseData))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*");
}

function getSheetData(sheetName) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  if (!sheet) return {status: "error", message: `Aba '${sheetName}' não encontrada.`};
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  return data.map(row => {
    const rowObject = {};
    headers.forEach((header, index) => { rowObject[header] = row[index]; });
    return rowObject;
  });
}
