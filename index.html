<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda do Corretor - Sistema de Agendamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { box-sizing: border-box; }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .property-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .time-slot { transition: all 0.2s ease; }
        .available:hover { transform: scale(1.05); }
        .available { background: linear-gradient(135deg, #10b981, #059669); cursor: pointer; }
        .occupied { background: linear-gradient(135deg, #ef4444, #dc2626); cursor: not-allowed; }
        .blocked { background: linear-gradient(135deg, #8b5cf6, #7c3aed); cursor: not-allowed; }
        .unavailable { background: linear-gradient(135deg, #6b7280, #4b5563); cursor: not-allowed; }
        .pending { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .image-preview { width: 100px; height: 100px; object-fit: cover; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold">üè† Agenda do Corretor</h1>
                <p class="text-gray-600">Seu sistema de agendamentos</p>
            </div>
            <form class="space-y-6">
                <div>
                    <label class="block text-sm font-medium">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Senha</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border rounded-lg" required>
                </div>
                <button type="button" id="loginButton" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-semibold">Entrar</button>
            </form>
            <div class="mt-4 text-center">
                <button id="showRegister" class="text-blue-600 hover:text-blue-700 text-sm font-medium">N√£o tem conta? Cadastre-se aqui</button>
            </div>
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm"><strong>Demo:</strong> Email: demo@corretor.com / Senha: 123456</p>
            </div>
        </div>
    </div>

    <!-- Tela de Cadastro -->
    <div id="registerScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold">üìù Cadastro de Corretor</h1>
                <p class="text-gray-600">Crie sua conta</p>
            </div>
            <form class="space-y-4">
                <div>
                    <label class="block text-sm">Nome Completo</label>
                    <input type="text" id="regName" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm">Email</label>
                    <input type="email" id="regEmail" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm">WhatsApp</label>
                    <input type="tel" id="regPhone" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm">Cidade</label>
                    <input type="text" id="regCity" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm">Senha</label>
                    <input type="password" id="regPassword" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <button type="button" id="registerButton" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-lg font-semibold">Cadastrar</button>
            </form>
            <div class="mt-4 text-center">
                <button id="showLogin" class="text-blue-600 hover:text-blue-700 text-sm font-medium">J√° tem conta? Fa√ßa login</button>
            </div>
        </div>
    </div>

    <!-- Tela Principal do Corretor -->
    <div id="mainApp" class="hidden min-h-screen">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">üè† Painel do Corretor</h1>
                        <span id="welcomeUser" class="ml-4 text-gray-600"></span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="shareUrlBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">üîó Meu Link</button>
                        <button id="logoutBtn" class="text-gray-600 hover:text-gray-800">Sair</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Agenda -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">üìÖ Agenda Semanal</h2>
                            <div class="flex gap-2">
                                <button id="prevWeek" class="bg-gray-200 px-3 py-1 rounded">‚Üê</button>
                                <button id="nextWeek" class="bg-gray-200 px-3 py-1 rounded">‚Üí</button>
                            </div>
                        </div>
                        <div id="calendar" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- Resumo -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üìä Resumo</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>Agendamentos:</span>
                                <span id="appointmentCount" class="font-bold text-blue-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Propriedades:</span>
                                <span id="propertyCount" class="font-bold text-green-600">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Propriedades -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üè° Propriedades</h3>
                        <div id="propertiesList" class="space-y-3 max-h-60 overflow-y-auto"></div>
                        <button id="addPropertyBtn" class="w-full mt-4 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">+ Adicionar Propriedade</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface do Cliente -->
    <div id="clientInterface" class="hidden min-h-screen">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">üè† Im√≥veis Dispon√≠veis</h1>
                        <span id="brokerNameDisplay" class="ml-4 text-gray-600"></span>
                    </div>
                    <div class="flex items-center">
                        <button id="backToPropertiesBtn" class="hidden bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">‚Üê Voltar</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Lista de Propriedades -->
            <div id="clientPropertiesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            
            <!-- Detalhes da Propriedade -->
            <div id="propertyDetails" class="hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div id="propertyImages" class="relative h-64 bg-gray-200"></div>
                    <div class="p-6">
                        <div id="propertyInfo" class="mb-6"></div>
                        <button id="scheduleVisitBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">üìÖ Agendar Visita</button>
                    </div>
                </div>
            </div>

            <!-- Agenda do Cliente -->
            <div id="clientCalendarSection" class="hidden mt-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Escolha o hor√°rio</h3>
                    <div class="flex justify-between items-center mb-4">
                        <button id="clientPrevWeek" class="bg-gray-200 px-3 py-1 rounded">‚Üê Semana Anterior</button>
                        <span id="clientWeekDisplay" class="font-medium"></span>
                        <button id="clientNextWeek" class="bg-gray-200 px-3 py-1 rounded">Pr√≥xima Semana ‚Üí</button>
                    </div>
                    <div id="clientCalendar" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Propriedade -->
    <div id="propertyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">üè° Adicionar Propriedade</h3>
            <form class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">T√≠tulo:</label>
                        <input type="text" id="propertyTitle" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Endere√ßo:</label>
                        <input type="text" id="propertyAddress" class="w-full border rounded-lg px-3 py-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo:</label>
                        <select id="propertyType" class="w-full border rounded-lg px-3 py-2">
                            <option>Casa</option>
                            <option>Apartamento</option>
                            <option>Terreno</option>
                            <option>Comercial</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Valor:</label>
                        <input type="text" id="propertyPrice" class="w-full border rounded-lg px-3 py-2" placeholder="R$ 0,00" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">√Årea (m¬≤):</label>
                        <input type="text" id="propertyArea" class="w-full border rounded-lg px-3 py-2" placeholder="100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Quartos:</label>
                        <input type="number" id="propertyRooms" class="w-full border rounded-lg px-3 py-2" min="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Descri√ß√£o:</label>
                    <textarea id="propertyDescription" class="w-full border rounded-lg px-3 py-2 h-20" placeholder="Descreva as caracter√≠sticas do im√≥vel..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Fotos (at√© 10):</label>
                    <input type="file" id="propertyImages" class="w-full border rounded-lg px-3 py-2" multiple accept="image/*">
                    <div id="imagePreview" class="mt-3 grid grid-cols-5 gap-2"></div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelProperty" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg">Cancelar</button>
                    <button type="button" id="saveProperty" class="flex-1 bg-green-600 text-white py-2 rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Compartilhar URL -->
    <div id="shareUrlModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">üîó Seu Link de Agendamento</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Link Personalizado:</label>
                    <div class="flex">
                        <input type="text" id="personalUrl" class="flex-1 border rounded-l-lg px-3 py-2 bg-gray-50" readonly>
                        <button id="copyUrlBtn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700 transition-colors">üìã</button>
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    <p>Compartilhe este link com seus clientes para que eles possam agendar visitas!</p>
                </div>
                <button id="closeUrlModal" class="w-full bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Agendamento do Cliente -->
    <div id="clientBookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">üìÖ Confirmar Agendamento</h3>
            <div id="bookingDetails" class="mb-4 p-3 bg-gray-50 rounded-lg"></div>
            <form class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Seu Nome:</label>
                    <input type="text" id="clientName" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">WhatsApp:</label>
                    <input type="tel" id="clientPhone" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Cidade:</label>
                    <input type="text" id="clientCity" class="w-full border rounded-lg px-3 py-2" required>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelBooking" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg">Cancelar</button>
                    <button type="button" id="confirmBooking" class="flex-1 bg-blue-600 text-white py-2 rounded-lg">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            let brokerInfo = null;
            let properties = [];
            let appointments = [];
            let currentWeek = new Date();
            let clientCurrentWeek = new Date();
            let selectedProperty = null;
            let selectedSlot = null;

            // Inicializar dados demo
            initializeDemoData();

            // --- Fun√ß√£o fake para WhatsApp ---
            async function sendWhatsApp(to, message) {
                console.log("[WhatsApp] Para:", to, "Mensagem:", message);
                showNotification("Mensagem enviada via WhatsApp!", "success");
            }

            // --- Salvar e carregar dados por corretor ---
            function saveData(key, value) {
                if (!brokerInfo?.email) return;
                localStorage.setItem(`${key}_${brokerInfo.email}`, JSON.stringify(value));
            }

            function loadData(key) {
                if (!brokerInfo?.email) return [];
                return JSON.parse(localStorage.getItem(`${key}_${brokerInfo.email}`) || "[]");
            }

            function saveBrokerData(brokerData) {
                localStorage.setItem(`broker_${brokerData.email}`, JSON.stringify(brokerData));
            }

            function loadBrokerData(email) {
                return JSON.parse(localStorage.getItem(`broker_${email}`) || "null");
            }

            // --- Inicializar dados demo ---
            function initializeDemoData() {
                const demoEmail = "demo@corretor.com";
                const demoBroker = {
                    name: "Jo√£o Silva",
                    email: demoEmail,
                    phone: "(11) 99999-9999",
                    city: "S√£o Paulo",
                    password: "123456",
                    urlCode: generateUrlCode()
                };

                if (!loadBrokerData(demoEmail)) {
                    saveBrokerData(demoBroker);
                    
                    // Salvar propriedades demo
                    localStorage.setItem(`properties_${demoEmail}`, JSON.stringify([
                        {
                            id: "1",
                            title: "Casa Moderna no Centro",
                            address: "Rua das Flores, 123 - Centro",
                            type: "Casa",
                            price: "R$ 450.000",
                            area: "120",
                            rooms: 3,
                            description: "Casa ampla com quintal, pr√≥xima ao centro da cidade.",
                            images: []
                        },
                        {
                            id: "2",
                            title: "Apartamento Vista Mar",
                            address: "Av. Beira Mar, 456 - Copacabana",
                            type: "Apartamento",
                            price: "R$ 680.000",
                            area: "85",
                            rooms: 2,
                            description: "Apartamento com vista para o mar, totalmente reformado.",
                            images: []
                        }
                    ]));
                }
            }

            // --- Gerar c√≥digo √∫nico ---
            function generateUrlCode() {
                return Math.random().toString(36).substring(2, 8);
            }

            // --- Notifica√ß√µes ---
            function showNotification(message, type = "success") {
                const notification = document.createElement('div');
                notification.className = `notification p-4 rounded-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                notification.textContent = message;
                document.getElementById('notifications').appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }

            // --- Convers√£o de arquivo para base64 ---
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // --- Bloqueio de hor√°rio pessoal ---
            window.blockPersonalTime = function(slotDateTime) {
                const reason = prompt("Motivo do bloqueio (ex: Almo√ßo, Consulta):");
                if (!reason) return;
                
                appointments.push({
                    id: Date.now().toString(),
                    date: slotDateTime.toISOString(),
                    clientName: "Bloqueio Pessoal",
                    clientPhone: "",
                    clientCity: "",
                    property_id: "",
                    property_title: reason,
                    status: "blocked"
                });
                
                saveData("appointments", appointments);
                showNotification("Hor√°rio bloqueado com sucesso!", "success");
                generateCalendar();
            }

            // --- Gerar calend√°rio ---
            function generateCalendar(isClient = false) {
                const calendar = document.getElementById(isClient ? 'clientCalendar' : 'calendar');
                if (!calendar) return;

                const week = isClient ? clientCurrentWeek : currentWeek;
                const startDate = new Date(week);
                startDate.setDate(startDate.getDate() - startDate.getDay());

                calendar.innerHTML = '';
                const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                const hours = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];

                // Cabe√ßalho dos dias
                let headerHtml = '<div class="grid grid-cols-8 gap-1 mb-2"><div class="p-2 font-bold text-center">Hor√°rio</div>';
                for (let day = 0; day < 7; day++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + day);
                    headerHtml += `<div class="p-2 font-bold text-center text-sm">
                        ${days[day]}<br>
                        <span class="text-xs text-gray-500">${date.getDate()}/${date.getMonth() + 1}</span>
                    </div>`;
                }
                headerHtml += '</div>';

                // Grid de hor√°rios
                let gridHtml = '<div class="space-y-1">';
                hours.forEach(hour => {
                    gridHtml += '<div class="grid grid-cols-8 gap-1">';
                    gridHtml += `<div class="p-2 text-sm font-medium text-center bg-gray-100 rounded">${hour}</div>`;
                    
                    for (let day = 0; day < 7; day++) {
                        const date = new Date(startDate);
                        date.setDate(date.getDate() + day);
                        date.setHours(parseInt(hour.split(':')[0]), parseInt(hour.split(':')[1]), 0, 0);
                        
                        const appointment = appointments.find(apt => {
                            const aptDate = new Date(apt.date);
                            return aptDate.getTime() === date.getTime();
                        });

                        let slotClass = 'available';
                        let slotContent = '';
                        let clickHandler = '';

                        if (appointment) {
                            if (appointment.status === 'blocked') {
                                slotClass = 'blocked';
                                slotContent = appointment.property_title;
                            } else {
                                slotClass = 'occupied';
                                slotContent = isClient ? 'Ocupado' : appointment.clientName;
                            }
                        } else {
                            if (isClient) {
                                clickHandler = `onclick="selectTimeSlot('${date.toISOString()}')"`;
                            } else {
                                clickHandler = `onclick="blockPersonalTime(new Date('${date.toISOString()}'))"`;
                            }
                        }

                        gridHtml += `<div class="time-slot ${slotClass} text-white text-center p-2 rounded text-xs cursor-pointer" ${clickHandler}>
                            ${slotContent}
                        </div>`;
                    }
                    gridHtml += '</div>';
                });
                gridHtml += '</div>';

                calendar.innerHTML = headerHtml + gridHtml;

                // Atualizar display da semana para cliente
                if (isClient) {
                    const weekDisplay = document.getElementById('clientWeekDisplay');
                    if (weekDisplay) {
                        const endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + 6);
                        weekDisplay.textContent = `${startDate.getDate()}/${startDate.getMonth() + 1} - ${endDate.getDate()}/${endDate.getMonth() + 1}`;
                    }
                }
            }

            // --- Selecionar hor√°rio (cliente) ---
            window.selectTimeSlot = function(dateTimeString) {
                selectedSlot = new Date(dateTimeString);
                document.getElementById('clientCalendarSection').classList.add('hidden');
                
                const bookingDetails = document.getElementById('bookingDetails');
                bookingDetails.innerHTML = `
                    <h4 class="font-bold">${selectedProperty.title}</h4>
                    <p class="text-sm text-gray-600">${selectedProperty.address}</p>
                    <p class="text-green-600 font-bold">${selectedProperty.price}</p>
                    <p class="text-blue-600 font-medium">
                        ${selectedSlot.toLocaleDateString('pt-BR')} √†s ${selectedSlot.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                    </p>
                `;
                
                document.getElementById('clientBookingModal').classList.remove('hidden');
            }

            // --- Carregar propriedades ---
            function loadProperties() {
                properties = loadData("properties");
                updatePropertiesDisplay();
                updatePropertyCount();
            }

            function updatePropertiesDisplay() {
                const container = document.getElementById('propertiesList');
                if (!container) return;
                
                container.innerHTML = '';
                properties.forEach(property => {
                    const div = document.createElement('div');
                    div.className = 'property-card bg-gray-50 p-3 rounded-lg transition-all duration-200 cursor-pointer';
                    div.innerHTML = `
                        <div class="font-medium text-sm">${property.title}</div>
                        <div class="text-xs text-gray-600 mb-1">${property.address}</div>
                        <div class="text-sm font-bold text-green-600">${property.price}</div>
                    `;
                    container.appendChild(div);
                });
            }

            function updatePropertyCount() {
                const countElement = document.getElementById('propertyCount');
                if (countElement) {
                    countElement.textContent = properties.length;
                }
            }

            function updateAppointmentCount() {
                const countElement = document.getElementById('appointmentCount');
                if (countElement) {
                    countElement.textContent = appointments.filter(apt => apt.status !== 'blocked').length;
                }
            }

            // --- Carregar propriedades para cliente ---
            function loadClientProperties(brokerEmail) {
                const brokerProperties = JSON.parse(localStorage.getItem(`properties_${brokerEmail}`) || "[]");
                const container = document.getElementById('clientPropertiesList');
                container.innerHTML = '';

                if (brokerProperties.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Nenhum im√≥vel cadastrado ainda.</div>';
                    return;
                }

                brokerProperties.forEach(property => {
                    const div = document.createElement('div');
                    div.className = 'property-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer transition-all duration-200';
                    
                    const imageHtml = property.images && property.images.length > 0 
                        ? `<img src="${property.images[0]}" class="w-full h-48 object-cover">`
                        : `<div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500">üè† Sem foto</div>`;
                    
                    div.innerHTML = `
                        ${imageHtml}
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2">${property.title}</h3>
                            <p class="text-gray-600 text-sm mb-2">${property.address}</p>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-green-600 font-bold text-xl">${property.price}</span>
                                ${property.area ? `<span class="text-gray-500 text-sm">${property.area}m¬≤</span>` : ''}
                            </div>
                            ${property.rooms ? `<div class="text-sm text-gray-600">üõèÔ∏è ${property.rooms} quartos</div>` : ''}
                        </div>
                    `;
                    
                    div.addEventListener('click', () => showPropertyDetails(property, brokerEmail));
                    container.appendChild(div);
                });
            }

            // --- Mostrar detalhes da propriedade ---
            function showPropertyDetails(property, brokerEmail) {
                selectedProperty = property;
                
                // Carregar agendamentos do corretor
                appointments = JSON.parse(localStorage.getItem(`appointments_${brokerEmail}`) || "[]");
                
                document.getElementById('clientPropertiesList').classList.add('hidden');
                document.getElementById('propertyDetails').classList.remove('hidden');
                document.getElementById('backToPropertiesBtn').classList.remove('hidden');
                
                // Mostrar imagens
                const imagesContainer = document.getElementById('propertyImages');
                if (property.images && property.images.length > 0) {
                    imagesContainer.innerHTML = `<img src="${property.images[0]}" class="w-full h-full object-cover">`;
                } else {
                    imagesContainer.innerHTML = `<div class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-500 text-2xl">üè† Sem foto</div>`;
                }
                
                // Mostrar informa√ß√µes
                const infoContainer = document.getElementById('propertyInfo');
                infoContainer.innerHTML = `
                    <h2 class="text-2xl font-bold mb-2">${property.title}</h2>
                    <p class="text-gray-600 mb-4">${property.address}</p>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-green-600 font-bold text-3xl">${property.price}</span>
                        ${property.area ? `<span class="text-gray-500">${property.area}m¬≤</span>` : ''}
                    </div>
                    ${property.rooms ? `<div class="flex gap-6 mb-4"><span class="flex items-center gap-2">üõèÔ∏è ${property.rooms} quartos</span></div>` : ''}
                    ${property.description ? `<p class="text-gray-700">${property.description}</p>` : ''}
                `;
            }

            // --- Event Listeners ---

            // Navega√ß√£o entre telas
            document.getElementById('showRegister').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('registerScreen').classList.remove('hidden');
            });

            document.getElementById('showLogin').addEventListener('click', () => {
                document.getElementById('registerScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            });

            // Login
            document.getElementById('loginButton').addEventListener('click', () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                const broker = loadBrokerData(email);
                if (broker && broker.password === password) {
                    brokerInfo = broker;
                    properties = loadData("properties");
                    appointments = loadData("appointments");
                    
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('welcomeUser').textContent = `Ol√°, ${broker.name}`;
                    
                    generateCalendar();
                    loadProperties();
                    updateAppointmentCount();
                    showNotification('Login realizado com sucesso!');
                } else {
                    showNotification('Email ou senha incorretos!', 'error');
                }
            });

            // Cadastro
            document.getElementById('registerButton').addEventListener('click', () => {
                const name = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const phone = document.getElementById('regPhone').value;
                const city = document.getElementById('regCity').value;
                const password = document.getElementById('regPassword').value;

                if (!name || !email || !phone || !city || !password) {
                    showNotification('Preencha todos os campos!', 'error');
                    return;
                }

                if (loadBrokerData(email)) {
                    showNotification('Email j√° cadastrado!', 'error');
                    return;
                }

                const newBroker = {
                    name, email, phone, city, password,
                    urlCode: generateUrlCode()
                };

                saveBrokerData(newBroker);
                showNotification('Cadastro realizado com sucesso!');
                
                document.getElementById('registerScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                brokerInfo = null;
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                showNotification('Logout realizado com sucesso!');
            });

            // Navega√ß√£o da agenda
            document.getElementById('prevWeek').addEventListener('click', () => {
                currentWeek.setDate(currentWeek.getDate() - 7);
                generateCalendar();
            });

            document.getElementById('nextWeek').addEventListener('click', () => {
                currentWeek.setDate(currentWeek.getDate() + 7);
                generateCalendar();
            });

            // Navega√ß√£o da agenda do cliente
            document.getElementById('clientPrevWeek').addEventListener('click', () => {
                clientCurrentWeek.setDate(clientCurrentWeek.getDate() - 7);
                generateCalendar(true);
            });

            document.getElementById('clientNextWeek').addEventListener('click', () => {
                clientCurrentWeek.setDate(clientCurrentWeek.getDate() + 7);
                generateCalendar(true);
            });

            // Compartilhar URL
            document.getElementById('shareUrlBtn').addEventListener('click', () => {
                const personalUrl = `${window.location.origin}${window.location.pathname}?c=${brokerInfo.urlCode}`;
                document.getElementById('personalUrl').value = personalUrl;
                document.getElementById('shareUrlModal').classList.remove('hidden');
            });

            document.getElementById('copyUrlBtn').addEventListener('click', () => {
                const urlField = document.getElementById('personalUrl');
                urlField.select();
                document.execCommand('copy');
                showNotification('Link copiado!');
            });

            document.getElementById('closeUrlModal').addEventListener('click', () => {
                document.getElementById('shareUrlModal').classList.add('hidden');
            });

            // Adicionar propriedade
            document.getElementById('addPropertyBtn').addEventListener('click', () => {
                document.getElementById('propertyModal').classList.remove('hidden');
            });

            document.getElementById('cancelProperty').addEventListener('click', () => {
                document.getElementById('propertyModal').classList.add('hidden');
            });

            // Preview de imagens
            document.getElementById('propertyImages').addEventListener('change', async function(e) {
                const files = Array.from(e.target.files).slice(0, 10);
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = '';

                for (let file of files) {
                    const base64 = await fileToBase64(file);
                    const img = document.createElement('img');
                    img.src = base64;
                    img.className = 'image-preview rounded-lg border';
                    preview.appendChild(img);
                }
            });

            // Salvar propriedade
            document.getElementById('saveProperty').addEventListener('click', async () => {
                const title = document.getElementById('propertyTitle').value;
                const address = document.getElementById('propertyAddress').value;
                const type = document.getElementById('propertyType').value;
                const price = document.getElementById('propertyPrice').value;
                const area = document.getElementById('propertyArea').value;
                const rooms = document.getElementById('propertyRooms').value;
                const description = document.getElementById('propertyDescription').value;
                const imageFiles = document.getElementById('propertyImages').files;

                if (!title || !address || !price) {
                    showNotification('Preencha os campos obrigat√≥rios!', 'error');
                    return;
                }

                // Converter imagens para base64
                const images = [];
                for (let file of imageFiles) {
                    if (images.length >= 10) break;
                    const base64 = await fileToBase64(file);
                    images.push(base64);
                }

                const newProperty = {
                    id: Date.now().toString(),
                    title, address, type, price, area,
                    rooms: parseInt(rooms) || 0,
                    description, images
                };

                properties.push(newProperty);
                saveData("properties", properties);
                
                document.getElementById('propertyModal').classList.add('hidden');
                
                // Limpar formul√°rio
                document.getElementById('propertyTitle').value = '';
                document.getElementById('propertyAddress').value = '';
                document.getElementById('propertyPrice').value = '';
                document.getElementById('propertyArea').value = '';
                document.getElementById('propertyRooms').value = '';
                document.getElementById('propertyDescription').value = '';
                document.getElementById('propertyImages').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                
                loadProperties();
                showNotification('Propriedade adicionada com sucesso!');
            });

            // Voltar para propriedades (cliente)
            document.getElementById('backToPropertiesBtn').addEventListener('click', () => {
                document.getElementById('propertyDetails').classList.add('hidden');
                document.getElementById('clientCalendarSection').classList.add('hidden');
                document.getElementById('clientPropertiesList').classList.remove('hidden');
                document.getElementById('backToPropertiesBtn').classList.add('hidden');
            });

            // Agendar visita
            document.getElementById('scheduleVisitBtn').addEventListener('click', () => {
                document.getElementById('propertyDetails').classList.add('hidden');
                document.getElementById('clientCalendarSection').classList.remove('hidden');
                generateCalendar(true);
            });

            // Cancelar agendamento
            document.getElementById('cancelBooking').addEventListener('click', () => {
                document.getElementById('clientBookingModal').classList.add('hidden');
                document.getElementById('clientCalendarSection').classList.remove('hidden');
            });

            // Confirmar agendamento
            document.getElementById('confirmBooking').addEventListener('click', () => {
                const clientName = document.getElementById('clientName').value;
                const clientPhone = document.getElementById('clientPhone').value;
                const clientCity = document.getElementById('clientCity').value;

                if (!clientName || !clientPhone || !clientCity) {
                    showNotification('Preencha todos os campos!', 'error');
                    return;
                }

                // Salvar agendamento no localStorage do corretor
                const brokerEmail = brokerInfo?.email || getBrokerEmailFromUrl();
                const brokerAppointments = JSON.parse(localStorage.getItem(`appointments_${brokerEmail}`) || "[]");
                
                const newAppointment = {
                    id: Date.now().toString(),
                    date: selectedSlot.toISOString(),
                    clientName,
                    clientPhone,
                    clientCity,
                    property_id: selectedProperty.id,
                    property_title: selectedProperty.title,
                    status: "confirmed"
                };

                brokerAppointments.push(newAppointment);
                localStorage.setItem(`appointments_${brokerEmail}`, JSON.stringify(brokerAppointments));

                // Enviar WhatsApp
                const broker = loadBrokerData(brokerEmail);
                if (broker) {
                    const message = `Nova visita agendada!\n\nCliente: ${clientName}\nTelefone: ${clientPhone}\nIm√≥vel: ${selectedProperty.title}\nData: ${selectedSlot.toLocaleDateString('pt-BR')} √†s ${selectedSlot.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}`;
                    sendWhatsApp(broker.phone, message);
                }

                document.getElementById('clientBookingModal').classList.add('hidden');
                
                // Limpar formul√°rio
                document.getElementById('clientName').value = '';
                document.getElementById('clientPhone').value = '';
                document.getElementById('clientCity').value = '';
                
                showNotification('Visita agendada com sucesso!');
                
                // Voltar para lista de propriedades
                setTimeout(() => {
                    document.getElementById('clientCalendarSection').classList.add('hidden');
                    document.getElementById('clientPropertiesList').classList.remove('hidden');
                    document.getElementById('backToPropertiesBtn').classList.add('hidden');
                }, 2000);
            });

            // Fun√ß√£o para obter email do corretor pela URL
            function getBrokerEmailFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('c');
                if (code) {
                    // Procurar corretor pelo c√≥digo
                    const allBrokers = Object.keys(localStorage).filter(key => key.startsWith('broker_'));
                    for (let key of allBrokers) {
                        const broker = JSON.parse(localStorage.getItem(key));
                        if (broker.urlCode === code) {
                            return broker.email;
                        }
                    }
                }
                return null;
            }

            // Verificar se h√° c√≥digo de corretor na URL
            const urlParams = new URLSearchParams(window.location.search);
            const realtorCode = urlParams.get('c');
            
            if (realtorCode) {
                // Encontrar corretor pelo c√≥digo
                const allBrokers = Object.keys(localStorage).filter(key => key.startsWith('broker_'));
                let foundBroker = null;
                
                for (let key of allBrokers) {
                    const broker = JSON.parse(localStorage.getItem(key));
                    if (broker.urlCode === realtorCode) {
                        foundBroker = broker;
                        break;
                    }
                }
                
                if (foundBroker) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('clientInterface').classList.remove('hidden');
                    document.getElementById('brokerNameDisplay').textContent = `Corretor: ${foundBroker.name}`;
                    loadClientProperties(foundBroker.email);
                    showNotification(`Bem-vindo! Veja os im√≥veis de ${foundBroker.name}`, 'success');
                } else {
                    showNotification('Corretor n√£o encontrado!', 'error');
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'985b3669a228caee',t:'MTc1ODk3ODMyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
