<script>
const apiUrl = 'https://sheetdb.io/api/v1/f581ql5gbuc71'; 
const imgbbApiKey = 'c9e158216e49f2c854478979da850aff';
const scheduleConfig = { startTime: 9, endTime: 18, slotDuration: 60 };
let currentBroker = null;

// utilitário: alertas bonitinhos
function showAlert(id, message, type = "success") {
  const el = document.getElementById(id);
  el.textContent = message;
  el.className = `notification mb-4 p-3 rounded border ${
    type === "error" ? "bg-red-600/30 border-red-500 text-red-200" :
    type === "success" ? "bg-green-600/30 border-green-500 text-green-200" :
    "bg-yellow-600/30 border-yellow-500 text-yellow-200"
  }`;
  el.classList.remove("hidden");
  setTimeout(() => el.classList.add("hidden"), 4000);
}

// trocar seções
function showSection(id) {
  ["loginSection","dashboardSection","clientSection"].forEach(sec=>{
    document.getElementById(sec).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

// ====================== REGISTRO ======================
document.getElementById("registerForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const newBroker = {
    name: document.getElementById("regName").value,
    creci: document.getElementById("regCreci").value,
    email: document.getElementById("regEmail").value,
    phone: document.getElementById("regPhone").value,
    password: document.getElementById("regPassword").value
  };

  try {
    await fetch(apiUrl, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ data: [newBroker] })
    });
    showAlert("alert-login","Conta criada com sucesso! Faça login.","success");
    e.target.reset();
  } catch(err){
    showAlert("alert-login","Erro ao registrar.","error");
  }
});

// ====================== LOGIN ======================
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const email = document.getElementById("loginEmail").value;
  const pass = document.getElementById("loginPassword").value;

  try {
    const res = await fetch(`${apiUrl}/search?email=${email}&password=${pass}`);
    const data = await res.json();
    if(data.length){
      currentBroker = data[0];
      document.getElementById("currentBrokerName").textContent = currentBroker.name;
      document.getElementById("shareLink").value = window.location.origin + "?broker=" + currentBroker.email;
      showSection("dashboardSection");
    } else {
      showAlert("alert-login","Credenciais inválidas.","error");
    }
  } catch(err){
    showAlert("alert-login","Erro ao logar.","error");
  }
});

// ====================== LOGOUT ======================
document.getElementById("btn-logout").addEventListener("click",()=>{
  currentBroker = null;
  showSection("loginSection");
});

// ====================== IMÓVEIS ======================
document.getElementById("btn-new-property").addEventListener("click", ()=>{
  const modal = document.getElementById("modal");
  document.getElementById("modalContent").innerHTML = `
    <h3 class="text-xl text-white mb-3">Novo Imóvel</h3>
    <form id="newPropertyForm" class="space-y-3">
      <input type="text" id="propTitle" required placeholder="Título" class="w-full p-2 bg-neutral-800 text-white rounded"/>
      <input type="file" id="propImage" accept="image/*" required class="w-full"/>
      <textarea id="propDesc" placeholder="Descrição" class="w-full p-2 bg-neutral-800 text-white rounded"></textarea>
      <button class="w-full bg-blue-600 text-white rounded p-2">Salvar</button>
    </form>
  `;
  modal.classList.remove("hidden","opacity-0");
  
  document.getElementById("newPropertyForm").addEventListener("submit", async ev=>{
    ev.preventDefault();
    const file = document.getElementById("propImage").files[0];
    let imageUrl = "";

    // upload no imgbb
    const fd = new FormData();
    fd.append("image", file);
    const upload = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
      method:"POST", body: fd
    });
    const upRes = await upload.json();
    imageUrl = upRes.data.url;

    const property = {
      broker: currentBroker.email,
      title: document.getElementById("propTitle").value,
      description: document.getElementById("propDesc").value,
      image: imageUrl
    };

    await fetch(apiUrl,{
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ data:[property] })
    });

    loadProperties();
    modal.classList.add("hidden");
  });
});

document.getElementById("modalClose").addEventListener("click",()=>{
  document.getElementById("modal").classList.add("hidden");
});

async function loadProperties(){
  const res = await fetch(`${apiUrl}/search?broker=${currentBroker.email}`);
  const data = await res.json();
  const list = document.getElementById("propertiesList");
  list.innerHTML = "";
  data.forEach(prop=>{
    const div = document.createElement("div");
    div.className="p-3 border border-neutral-700 rounded bg-neutral-800";
    div.innerHTML = `
      <h4 class="font-semibold text-white">${prop.title}</h4>
      <img src="${prop.image}" class="w-full h-32 object-cover rounded my-2"/>
      <p class="text-sm text-gray-300">${prop.description||""}</p>
    `;
    list.appendChild(div);
  });
}

// ====================== AGENDA ======================
document.getElementById("blockTimeForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const block = {
    broker: currentBroker.email,
    date: document.getElementById("blockDate").value,
    time: document.getElementById("blockTime").value,
    reason: document.getElementById("blockReason").value
  };
  await fetch(apiUrl,{ method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({data:[block]}) });
  showAlert("alert-dashboard","Horário bloqueado com sucesso.","success");
});

// ====================== CLIENTE ======================
document.getElementById("btn-show-client-interface").addEventListener("click", ()=>{
  showSection("clientSection");
  loadClientProperties();
});

document.getElementById("btn-back-to-login").addEventListener("click", ()=>{
  showSection("loginSection");
});

async function loadClientProperties(){
  const res = await fetch(apiUrl);
  const data = await res.json();
  const list = document.getElementById("clientProperties");
  list.innerHTML="";
  data.filter(d=>d.title).forEach(prop=>{
    const div = document.createElement("div");
    div.className="border border-neutral-700 rounded bg-neutral-800 p-3";
    div.innerHTML=`
      <h4 class="text-white font-semibold">${prop.title}</h4>
      <img src="${prop.image}" class="w-full h-32 object-cover rounded my-2"/>
      <p class="text-sm text-gray-400">${prop.description||""}</p>
    `;
    list.appendChild(div);
  });
}
</script>
