<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda do Corretor - Sistema de Agendamento</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .notification { animation: slideIn 0.25s ease-out; }
    @keyframes slideIn { from { transform: translateY(10px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="app" class="min-h-screen flex items-start justify-center p-6">
    <div class="w-full max-w-5xl bg-white/80 rounded-2xl shadow-lg p-6">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold text-slate-800">Agenda do Corretor</h1>
        <div>
          <button id="btn-show-login" class="px-3 py-1 mr-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Login</button>
          <button id="btn-show-register" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Cadastrar</button>
        </div>
      </header>

      <div id="alert" class="hidden notification mb-4 p-3 rounded border"></div>

      <main>
        <!-- LOGIN -->
        <section id="loginSection" class="">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-3">Entrar (corretores)</h2>
              <form id="loginForm" class="space-y-3">
                <input id="loginEmail" type="email" required placeholder="Email" class="w-full p-2 border rounded" />
                <input id="loginPassword" type="password" required placeholder="Senha" class="w-full p-2 border rounded" />
                <div class="flex items-center gap-2">
                  <button class="px-3 py-2 bg-indigo-600 text-white rounded">Entrar</button>
                  <button id="btn-show-client-interface" type="button" class="px-3 py-2 bg-gray-200 rounded">Ver todos os imóveis</button>
                </div>
              </form>
            </div>

            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-3">Cadastrar corretor</h2>
              <form id="registerForm" class="space-y-3">
                <input id="regName" type="text" required placeholder="Nome" class="w-full p-2 border rounded" />
                <input id="regEmail" type="email" required placeholder="Email" class="w-full p-2 border rounded" />
                <input id="regPhone" type="text" placeholder="Telefone" class="w-full p-2 border rounded" />
                <input id="regPassword" type="password" required placeholder="Senha" class="w-full p-2 border rounded" />
                <button class="px-3 py-2 bg-green-600 text-white rounded">Criar conta</button>
              </form>
            </div>
          </div>
        </section>

        <!-- DASHBOARD -->
        <section id="dashboardSection" class="hidden">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Painel</h2>
            <div class="flex items-center gap-2">
              <span id="currentBrokerName" class="text-slate-600"></span>
              <button id="btn-logout" class="px-3 py-1 bg-red-500 text-white rounded">Sair</button>
            </div>
          </div>
          
          <!-- Link de Divulgação -->
          <div id="shareLinkContainer" class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
            <label for="shareLink" class="block text-sm font-medium text-indigo-800">Link para enviar aos clientes:</label>
            <div class="flex items-center gap-2 mt-1">
              <input type="text" id="shareLink" readonly class="w-full p-2 border border-indigo-300 bg-white rounded-md text-sm">
              <button id="btn-copy-link" class="px-3 py-2 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700">Copiar</button>
              <button id="btn-open-link" class="px-3 py-2 bg-green-600 text-white rounded-md text-sm hover:bg-green-700">Abrir</button>
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <div class="md:col-span-2 p-4 bg-white rounded shadow">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Meus Imóveis</h3>
                <button id="btn-new-property" class="px-3 py-1 bg-indigo-600 text-white rounded">Novo imóvel</button>
              </div>
              <div id="propertiesList" class="space-y-3"></div>
            </div>

            <div class="p-4 bg-white rounded shadow">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Minha Agenda</h3>
              </div>
              <div id="appointmentsList" class="space-y-2 text-sm max-h-96 overflow-y-auto pr-2"></div>
              <hr class="my-3" />
              <h4 class="font-medium mb-2">Bloquear horário pessoal</h4>
              <form id="blockTimeForm" class="space-y-2">
                <input id="blockDate" type="date" required class="w-full p-2 border rounded" />
                <input id="blockTime" type="time" required class="w-full p-2 border rounded" />
                <input id="blockReason" type="text" placeholder="Motivo (opcional)" class="w-full p-2 border rounded" />
                <button class="px-3 py-1 bg-yellow-500 rounded text-yellow-900">Bloquear</button>
              </form>
            </div>
          </div>
        </section>

        <!-- CLIENTE -->
        <section id="clientSection" class="hidden">
          <div class="flex items-center justify-between mb-4">
            <h2 id="client-title" class="text-xl font-semibold">Propriedades disponíveis</h2>
            <button id="btn-back-to-login" class="px-3 py-1 bg-gray-200 rounded">Voltar</button>
          </div>
          <div id="clientProperties" class="grid md:grid-cols-3 gap-4"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4 z-50">
    <div class="bg-white rounded-lg shadow p-4 w-full max-w-2xl">
      <div id="modalContent"></div>
      <div class="mt-3 text-right">
        <button id="modalClose" class="px-3 py-1 bg-gray-200 rounded">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const apiUrl = 'https://sheetdb.io/api/v1/tur3stthjmeet'; // troque se precisar
    const imgbbApiKey = '6993ede4d1aa2ecce3147a7ee06c0b00';

    let currentBroker = null;
    let properties = [];
    let appointments = [];
    let brokers = [];

    function showOnly(sectionId) {
      ['loginSection','dashboardSection','clientSection'].forEach(s => document.getElementById(s).classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
    }

    function showAlert(message, type = 'success') {
      const alertEl = document.getElementById('alert');
      alertEl.textContent = message;
      alertEl.className = 'notification mb-4 p-3 rounded border ';
      alertEl.classList.add(type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700');
      alertEl.classList.remove('hidden');
      setTimeout(() => alertEl.classList.add('hidden'), 4000);
    }

    function showModal(htmlContent) {
      document.getElementById('modalContent').innerHTML = htmlContent;
      document.getElementById('modal').classList.add('flex');
      document.getElementById('modal').classList.remove('hidden');
    }
    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.getElementById('modal').classList.remove('flex');
      document.getElementById('modalContent').innerHTML = '';
    }

    async function fetchData() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        brokers = data.filter(i => i.type === 'broker');
        properties = data.filter(i => i.type === 'property');
        appointments = data.filter(i => i.type === 'appointment');
      } catch (err) { console.error(err); showAlert('Erro ao carregar dados','error'); }
    }

    async function postData(data) {
      try {
        const res = await fetch(apiUrl, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({data:[data]})
        });
        return await res.json();
      } catch (err) { console.error(err); showAlert('Erro ao salvar','error'); }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const newBroker = {
        id:`broker_${Date.now()}`, type:'broker',
        name:regName.value, email:regEmail.value, phone:regPhone.value,
        password:regPassword.value
      };
      if (!newBroker.name || !newBroker.email || !newBroker.password) return showAlert('Preencha todos os campos','error');
      if (brokers.find(b=>b.email===newBroker.email)) return showAlert('Email já cadastrado','error');
      await postData(newBroker); showAlert('Cadastro realizado!','success');
      registerForm.reset(); await fetchData();
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email=loginEmail.value, pass=loginPassword.value;
      const broker=brokers.find(b=>b.email===email && b.password===pass);
      if(broker){ currentBroker=broker; showOnly('dashboardSection'); renderDashboard(); }
      else showAlert('Email ou senha inválidos','error');
    }
    function handleLogout(){ currentBroker=null; showOnly('loginSection'); loginForm.reset(); }

    function renderDashboard(){
      if(!currentBroker) return;
      currentBrokerName.textContent=`Olá, ${currentBroker.name.split(' ')[0]}!`;
      const baseUrl = window.location.href.split('?')[0];
      shareLink.value=`${baseUrl}?brokerId=${currentBroker.id}`;
      // Imóveis e Agenda
      renderPropertiesList(properties.filter(p=>p.brokerId===currentBroker.id));
      renderAppointmentsList(appointments.filter(a=>a.brokerId===currentBroker.id));
    }

    function copyShareLink(){ shareLink.select(); document.execCommand('copy'); showAlert('Link copiado!'); }
    function openShareLink(){ window.open(shareLink.value,'_blank'); }

    function renderPropertiesList(props){
      propertiesList.innerHTML = props.length===0 ? '<p class="text-slate-500">Nenhum imóvel.</p>' :
        props.map(p=>`<div class="p-3 border rounded bg-slate-50"><p class="font-semibold">${p.title||'Imóvel'}</p><p class="text-sm">${p.address||''}</p></div>`).join('');
    }

    function renderAppointmentsList(appts){
      appointmentsList.innerHTML = appts.length===0 ? '<p class="text-slate-500">Nenhum agendamento.</p>' :
        appts.map(a=>{
          const d=new Date(`${a.date}T${a.time}`);
          return `<div class="p-2 bg-blue-50 rounded"><p class="font-semibold">${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</p><p class="text-xs">${a.clientName}</p></div>`;
        }).join('');
    }

    async function handleNewProperty(){
      showModal(`<h3 class="text-xl font-semibold mb-4">Novo Imóvel</h3>
      <form id="propertyForm" class="space-y-3">
        <input id="propTitle" placeholder="Título" required class="w-full p-2 border rounded">
        <input id="propAddress" placeholder="Endereço" required class="w-full p-2 border rounded">
        <input id="propPrice" placeholder="Preço" required class="w-full p-2 border rounded">
        <textarea id="propDescription" placeholder="Descrição" class="w-full p-2 border rounded"></textarea>
        <input type="file" id="propImage" accept="image/*" class="w-full text-sm">
        <button class="px-3 py-2 bg-indigo-600 text-white rounded">Salvar</button>
      </form>`);
      propertyForm.addEventListener('submit',handlePropertyFormSubmit);
    }

    async function handlePropertyFormSubmit(e){
      e.preventDefault();
      let imgUrl='';
      const f=propImage.files[0];
      if(f){ const fd=new FormData(); fd.append('image',f);
        const r=await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`,{method:'POST',body:fd});
        const j=await r.json(); if(j.success) imgUrl=j.data.url;
      }
      const newProp={id:`prop_${Date.now()}`,type:'property',brokerId:currentBroker.id,
        title:propTitle.value,address:propAddress.value,description:propDescription.value,price:propPrice.value,imageUrl:imgUrl};
      await postData(newProp); closeModal(); await fetchData(); renderDashboard();
    }

    async function handleBlockTime(e){
      e.preventDefault();
      const slot={id:`appt_${Date.now()}`,type:'appointment',brokerId:currentBroker.id,
        propertyId:'personal',clientName:'Horário Bloqueado',
        date:blockDate.value,time:blockTime.value,details:blockReason.value};
      await postData(slot); blockTimeForm.reset(); await fetchData(); renderDashboard();
    }

    async function showClientInterface(brokerId=null){
      showOnly('clientSection');
      if(!properties.length) await fetchData();
      let toShow=brokerId?properties.filter(p=>p.brokerId===brokerId):properties;
      clientProperties.innerHTML = toShow.length===0 ? '<p>Nenhum imóvel.</p>' :
        toShow.map(p=>`<div class="bg-white rounded shadow"><img src="${p.imageUrl||'https://via.placeholder.com/400x250'}" class="w-full h-40 object-cover"><div class="p-3"><h3 class="font-semibold">${p.title}</h3><p>${p.address}</p><p class="font-bold">${p.price}</p></div></div>`).join('');
      if(brokerId){ btn-back-to-login.classList.add('hidden'); }
    }

    window.addEventListener('load',async()=>{
      await fetchData();
      loginForm.addEventListener('submit',handleLogin);
      registerForm.addEventListener('submit',handleRegister);
      btn-show-client-interface.addEventListener('click',()=>showClientInterface());
      btn-back-to-login.addEventListener('click',()=>showOnly('loginSection'));
      btn-logout.addEventListener('click',handleLogout);
      btn-new-property.addEventListener('click',handleNewProperty);
      blockTimeForm.addEventListener('submit',handleBlockTime);
      btn-copy-link.addEventListener('click',copyShareLink);
      btn-open-link.addEventListener('click',openShareLink);
      modalClose.addEventListener('click',closeModal);
      modal.addEventListener('click',e=>{if(e.target.id==='modal') closeModal();});
      const brokerId=new URLSearchParams(location.search).get('brokerId');
      if(brokerId) showClientInterface(brokerId); else showOnly('loginSection');
    });
  </script>
</body>
</html>
