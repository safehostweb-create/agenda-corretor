<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda do Corretor - Sistema de Agendamento</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .notification { animation: slideIn 0.25s ease-out; }
    @keyframes slideIn { from { transform: translateY(10px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="app" class="min-h-screen flex items-start justify-center p-6">
    <div class="w-full max-w-5xl bg-white/80 rounded-2xl shadow-lg p-6">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold text-slate-800">Agenda do Corretor</h1>
        <div>
          <button id="btn-show-login" class="px-3 py-1 mr-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Login</button>
          <button id="btn-show-register" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Cadastrar</button>
        </div>
      </header>

      <!-- ALERT -->
      <div id="alert" class="hidden notification mb-4 p-3 rounded border"></div>

      <!-- SECTIONS -->
      <main>
        <!-- LOGIN -->
        <section id="loginSection" class="">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-3">Entrar (corretores)</h2>
              <form id="loginForm" class="space-y-3">
                <input id="loginEmail" type="email" required placeholder="Email" class="w-full p-2 border rounded" />
                <input id="loginPassword" type="password" required placeholder="Senha" class="w-full p-2 border rounded" />
                <div class="flex items-center gap-2">
                  <button class="px-3 py-2 bg-indigo-600 text-white rounded">Entrar</button>
                  <button id="btn-show-client-interface" type="button" class="px-3 py-2 bg-gray-200 rounded">Entrar como cliente</button>
                </div>
              </form>
            </div>

            <!-- REGISTER -->
            <div class="p-4 bg-white rounded shadow">
              <h2 class="font-semibold mb-3">Cadastrar corretor</h2>
              <form id="registerForm" class="space-y-3">
                <input id="regName" type="text" required placeholder="Nome" class="w-full p-2 border rounded" />
                <input id="regEmail" type="email" required placeholder="Email" class="w-full p-2 border rounded" />
                <input id="regPhone" type="text" placeholder="Telefone" class="w-full p-2 border rounded" />
                <input id="regPassword" type="password" required placeholder="Senha" class="w-full p-2 border rounded" />
                <button class="px-3 py-2 bg-green-600 text-white rounded">Criar conta</button>
              </form>
            </div>
          </div>
        </section>

        <!-- DASHBOARD -->
        <section id="dashboardSection" class="hidden">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Painel</h2>
            <div class="flex items-center gap-2">
              <span id="currentBrokerName" class="text-slate-600"></span>
              <button id="btn-logout" class="px-3 py-1 bg-red-500 text-white rounded">Sair</button>
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <!-- Imóveis -->
            <div class="col-span-2 p-4 bg-white rounded shadow">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Imóveis</h3>
                <button id="btn-new-property" class="px-3 py-1 bg-indigo-600 text-white rounded">Novo imóvel</button>
              </div>

              <div id="propertiesList" class="space-y-3">
                <!-- preenchido via JS -->
              </div>
            </div>

            <!-- Agenda -->
            <div class="p-4 bg-white rounded shadow">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Agenda</h3>
                <button id="btn-new-appointment" class="px-2 py-1 bg-green-600 text-white rounded">Novo</button>
              </div>

              <div id="appointmentsList" class="space-y-2 text-sm">
                <!-- preenchido via JS -->
              </div>

              <hr class="my-3" />
              <h4 class="font-medium mb-2">Bloquear horário pessoal</h4>
              <form id="blockTimeForm" class="space-y-2">
                <input id="blockDate" type="date" required class="w-full p-2 border rounded" />
                <input id="blockTime" type="time" required class="w-full p-2 border rounded" />
                <input id="blockReason" type="text" placeholder="Motivo (opcional)" class="w-full p-2 border rounded" />
                <button class="px-3 py-1 bg-yellow-500 rounded">Bloquear</button>
              </form>
            </div>
          </div>
        </section>

        <!-- CLIENT INTERFACE -->
        <section id="clientSection" class="hidden">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Propriedades disponíveis</h2>
            <button id="btn-back-to-login" class="px-3 py-1 bg-gray-200 rounded">Voltar</button>
          </div>

          <div id="clientProperties" class="grid md:grid-cols-3 gap-4">
            <!-- cards -->
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODAIS SIMPLES -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-lg shadow p-4 w-full max-w-2xl">
      <div id="modalContent"></div>
      <div class="mt-3 text-right">
        <button id="modalClose" class="px-3 py-1 bg-gray-200 rounded">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // CONFIGURAÇÕES - substitua se quiser
    const apiUrl = 'https://sheetdb.io/api/v1/8ejj2hh7op6w2'; // <- seu endpoint SheetDB
    const imgbbApiKey = '6993ede4d1aa2ecce3147a7ee06c0b00'; // já presente no seu arquivo
    // Fim das configurações

    // Estado local
    let currentBroker = null;
    let properties = [];
    let appointments = [];
    let brokers = [];

    // Utils
    function showAlert(message, type='info') {
      const el = document.getElementById('alert');
      el.className = 'notification mb-4 p-3 rounded border';
      el.classList.add(type === 'error' ? 'border-red-400 bg-red-50 text-red-800' : 'border-slate-200 bg-white text-slate-700');
      el.innerText = message;
      el.classList.remove('hidden');
      setTimeout(()=> el.classList.add('hidden'), 4500);
    }

    function openModal(html) {
      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('modal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    // Fetch helpers para SheetDB: GET / POST / PUT
    async function sheetGet(query = '') {
      const url = query ? `${apiUrl}/${query}` : apiUrl;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Erro na API SheetDB: ' + res.status);
      return await res.json();
    }

    async function sheetPost(row) {
      // sheetdb espera {data: {...}} para criar linha
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({data: row})
      });
      if (!res.ok) throw new Error('Falha ao criar registro: ' + res.status);
      return await res.json();
    }

    // Para atualização simples: o SheetDB permite POST para filtrar e sobrescrever - aqui fazemos append por simplicidade
    // Se precisar alterar uma linha existente é preciso saber o id da linha (ou a query) - implementação básica omitida por simplicidade.

    // INIT
    window.addEventListener('load', async () => {
      cacheDom();
      attachListeners();
      await loadAll(); // puxa dados iniciais
    });

    function cacheDom() {
      // botões e seções
      window.$ = selector => document.querySelector(selector);
    }

    function attachListeners() {
      document.getElementById('btn-show-login').addEventListener('click', ()=> showOnly('loginSection'));
      document.getElementById('btn-show-register').addEventListener('click', ()=> showOnly('loginSection'));
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('registerForm').addEventListener('submit', handleRegister);
      document.getElementById('btn-show-client-interface').addEventListener('click', showClientInterface);
      document.getElementById('btn-back-to-login').addEventListener('click', ()=> showOnly('loginSection'));
      document.getElementById('btn-logout').addEventListener('click', handleLogout);
      document.getElementById('modalClose').addEventListener('click', closeModal);
      document.getElementById('btn-new-property').addEventListener('click', () => openPropertyModal());
      document.getElementById('btn-new-appointment').addEventListener('click', () => openAppointmentModal());
      document.getElementById('blockTimeForm').addEventListener('submit', handleBlockTime);
    }

    function showOnly(sectionId) {
      const sections = ['loginSection','dashboardSection','clientSection'];
      sections.forEach(s => document.getElementById(s).classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
    }

    async function loadAll() {
      try {
        // Carrega tudo de uma vez - pode demorar dependendo da planilha
        const data = await sheetGet();
        // SheetDB geralmente devolve array de objetos; filtramos por "type" se existir
        // Se sua planilha não tem "type", talvez tudo esteja misturado — você pode adaptar.
        // Vamos tentar inferir: se houver um campo 'type' usamos, senão tentamos separar por 'email' (corretores) e 'title' (imóveis) e 'date' (appointments)
        if (!Array.isArray(data)) {
          showAlert('Resposta inesperada da API', 'error');
          return;
        }

        // Primeiro, se houver campo 'type'
        const hasType = data.length && Object.prototype.hasOwnProperty.call(data[0], 'type');

        if (hasType) {
          brokers = data.filter(r => r.type === 'broker');
          properties = data.filter(r => r.type === 'property');
          appointments = data.filter(r => r.type === 'appointment');
        } else {
          // heurística simples:
          brokers = data.filter(r => r.email && r.password); // corretores
          properties = data.filter(r => r.title || r.address);
          appointments = data.filter(r => r.date && r.time && r.broker_id);
        }
        renderAfterLoad();
      } catch (err) {
        console.error(err);
        showAlert('Não consegui carregar dados da planilha. Verifique o endpoint e CORS.', 'error');
      }
    }

    function renderAfterLoad() {
      // Se existe um corretor logado, mostra dashboard, senão login
      if (currentBroker) {
        showOnly('dashboardSection');
        document.getElementById('currentBrokerName').innerText = currentBroker.name || currentBroker.email;
        renderProperties();
        renderAppointments();
      } else {
        showOnly('loginSection');
      }
      renderClientProperties();
    }

    // ----------------------
    // AUTENTICAÇÃO
    // ----------------------
    async function handleRegister(e) {
      e.preventDefault();
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const password = document.getElementById('regPassword').value.trim();

      if (!name || !email || !password) return showAlert('Preencha os campos obrigatórios', 'error');

      try {
        // criar linha do tipo broker
        const newBroker = {
          type: 'broker',
          name, email, phone, password
        };
        await sheetPost(newBroker);
        showAlert('Corretor criado com sucesso. Faça login.');
        // recarrega
        await loadAll();
        document.getElementById('registerForm').reset();
      } catch (err) {
        console.error(err);
        showAlert('Erro ao criar corretor', 'error');
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      if (!email || !password) return showAlert('Email e senha são obrigatórios', 'error');

      // Busca na lista já carregada
      const found = brokers.find(b => (b.email === email) && (b.password === password));
      if (found) {
        currentBroker = found;
        localStorage.setItem('broker', JSON.stringify(currentBroker));
        showAlert('Login efetuado');
        renderAfterLoad();
      } else {
        // tentar buscar diretamente na API (caso não esteja em cache)
        try {
          const resp = await sheetGet(`?email=${encodeURIComponent(email)}`); // retorna itens com esse email
          const match = resp.find(r => r.type === 'broker' && r.password === password);
          if (match) {
            currentBroker = match;
            brokers.push(match);
            localStorage.setItem('broker', JSON.stringify(currentBroker));
            showAlert('Login efetuado');
            renderAfterLoad();
            return;
          }
        } catch (err) {
          console.error(err);
        }
        showAlert('Credenciais incorretas', 'error');
      }
    }

    function handleLogout() {
      currentBroker = null;
      localStorage.removeItem('broker');
      showOnly('loginSection');
      showAlert('Você saiu. Até a próxima confusão.');
    }

    // ----------------------
    // PROPRIEDADES
    // ----------------------
    function renderProperties() {
      const wrap = document.getElementById('propertiesList');
      wrap.innerHTML = '';
      const list = properties.filter(p => p.broker_id ? p.broker_id == currentBroker.email || p.broker_id == currentBroker.id : true); // tenta limitar aos do corretor
      if (!list.length) {
        wrap.innerHTML = '<div class="text-sm text-slate-500">Nenhum imóvel cadastrado ainda.</div>';
        return;
      }
      list.forEach(prop => {
        const card = document.createElement('div');
        card.className = 'p-3 border rounded flex items-start gap-3';
        const imgUrl = (prop.images && tryParseJSON(prop.images)?.[0]) || '';
        card.innerHTML = `
          <div class="w-28 h-20 bg-slate-100 rounded overflow-hidden flex items-center justify-center">
            ${imgUrl ? `<img src="${imgUrl}" class="object-cover w-full h-full" />` : `<span class="text-xs text-slate-400">Sem imagem</span>`}
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-semibold">${prop.title || '— sem título —'}</div>
                <div class="text-sm text-slate-500">${prop.address || prop.description || ''}</div>
              </div>
              <div class="text-right">
                <div class="font-medium">${prop.price ? 'R$ ' + prop.price : ''}</div>
                <div class="text-xs text-slate-400">ID: ${prop.id || prop._row}</div>
              </div>
            </div>
            <div class="mt-2 text-sm flex gap-2">
              <button class="px-2 py-1 bg-indigo-600 text-white rounded" onclick="openPropertyModal('${encodeURIComponent(JSON.stringify(prop))}')">Editar</button>
              <button class="px-2 py-1 bg-red-500 text-white rounded" onclick="deleteProperty('${prop.id || prop._row || ''}')">Excluir</button>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      });
    }

    // Abre modal para criar/editar imóvel. Se propEncoded definido, é edição.
    async function openPropertyModal(propEncoded) {
      let prop = null;
      if (propEncoded) prop = JSON.parse(decodeURIComponent(propEncoded));
      const html = `
        <h3 class="font-semibold mb-2">${prop ? 'Editar imóvel' : 'Novo imóvel'}</h3>
        <form id="propertyForm" class="space-y-2">
          <input id="propTitle" type="text" placeholder="Título" value="${prop?.title || ''}" class="w-full p-2 border rounded" required />
          <input id="propAddress" type="text" placeholder="Endereço" value="${prop?.address || ''}" class="w-full p-2 border rounded" />
          <textarea id="propDescription" placeholder="Descrição" class="w-full p-2 border rounded">${prop?.description || ''}</textarea>
          <input id="propPrice" type="text" placeholder="Preço" value="${prop?.price || ''}" class="w-full p-2 border rounded" />
          <label class="block text-sm text-slate-600">Imagens (1 ou mais) - selecione arquivos ou cole URLs separados por vírgula</label>
          <input id="propImagesFiles" type="file" accept="image/*" multiple class="w-full p-2 border rounded" />
          <input id="propImagesUrls" type="text" placeholder="Ou cole URLs separadas por vírgula" value="${prop?.images || ''}" class="w-full p-2 border rounded" />
          <div class="text-right">
            <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">${prop ? 'Salvar' : 'Criar'}</button>
          </div>
        </form>
      `;
      openModal(html);

      document.getElementById('propertyForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const title = document.getElementById('propTitle').value.trim();
        const address = document.getElementById('propAddress').value.trim();
        const description = document.getElementById('propDescription').value.trim();
        const price = document.getElementById('propPrice').value.trim();
        const files = document.getElementById('propImagesFiles').files;
        const urlsRaw = document.getElementById('propImagesUrls').value.trim();

        // 1) upload files to imgbb (se houver)
        let urls = [];
        if (urlsRaw) {
          // se o campo contém JSON ou lista, tentamos normalizar
          try {
            const parsed = tryParseJSON(urlsRaw);
            if (Array.isArray(parsed)) urls = parsed;
            else urls = urlsRaw.split(',').map(s=>s.trim()).filter(Boolean);
          } catch (err) { urls = urlsRaw.split(',').map(s=>s.trim()).filter(Boolean); }
        }

        if (files && files.length) {
          showAlert('Fazendo upload das imagens (pode demorar um pouco)...');
          for (let f of files) {
            try {
              const uploaded = await uploadToImgbb(f);
              if (uploaded) urls.push(uploaded);
            } catch (err) {
              console.warn('Erro upload', err);
            }
          }
        }

        // 2) montar objeto para salvar
        const row = {
          type: 'property',
          title, address, description, price,
          images: JSON.stringify(urls),
          broker_id: currentBroker?.email || currentBroker?.id || ''
        };

        try {
          if (prop && (prop.id || prop._row)) {
            // edição simples: cria nova linha com type=property e mark original (nota: para sobrescrever precisa query específica)
            // Implementação simples: criamos nova linha em vez de editar existente.
            await sheetPost(row);
            showAlert('Salvo (criado novo registro). Se quiser editar em vez de criar, me peça para integrar update por query).');
          } else {
            await sheetPost(row);
            showAlert('Imóvel criado.');
          }
          closeModal();
          await loadAll();
        } catch (err) {
          console.error(err);
          showAlert('Erro ao salvar imóvel', 'error');
        }
      });
    }

    async function deleteProperty(id) {
      // SheetDB delete precisa de endpoint específico /search? para deletar. Implementação omitida por segurança.
      if (!confirm('Excluir imóvel? (essa ação não está implementada no delete automático por segurança)')) return;
      showAlert('Para deletar uma linha pela API é preciso endpoint específico. Posso implementar se você permitir que eu use DELETE com a query correta.');
    }

    // ----------------------
    // APPOINTMENTS / AGENDA
    // ----------------------
    function renderAppointments() {
      const wrap = document.getElementById('appointmentsList');
      wrap.innerHTML = '';
      const list = appointments.filter(a => a.broker_id ? (a.broker_id == currentBroker.email || a.broker_id == currentBroker.id) : true);
      if (!list.length) { wrap.innerHTML = '<div class="text-sm text-slate-500">Sem agendamentos.</div>'; return; }
      list.forEach(a => {
        const el = document.createElement('div');
        el.className = 'p-2 border rounded';
        el.innerHTML = `<div class="flex justify-between items-center">
          <div>
            <div class="font-medium">${a.client_name || a.client || '— cliente —'}</div>
            <div class="text-xs text-slate-500">${a.date || ''} ${a.time || ''}</div>
            <div class="text-xs">${a.note || ''}</div>
          </div>
          <div class="text-sm">
            <button class="px-2 py-1 bg-red-500 text-white rounded" onclick="cancelAppointment('${a.id || a._row || ''}')">Cancelar</button>
          </div>
        </div>`;
        wrap.appendChild(el);
      });
    }

    function openAppointmentModal() {
      const html = `
        <h3 class="font-semibold mb-2">Novo agendamento</h3>
        <form id="appointmentForm" class="space-y-2">
          <input id="appClientName" type="text" placeholder="Nome do cliente" class="w-full p-2 border rounded" required />
          <input id="appClientPhone" type="text" placeholder="Telefone" class="w-full p-2 border rounded" />
          <input id="appDate" type="date" class="w-full p-2 border rounded" required />
          <input id="appTime" type="time" class="w-full p-2 border rounded" required />
          <textarea id="appNote" placeholder="Observações" class="w-full p-2 border rounded"></textarea>
          <div class="text-right"><button class="px-3 py-1 bg-green-600 text-white rounded">Agendar</button></div>
        </form>
      `;
      openModal(html);

      document.getElementById('appointmentForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const client_name = document.getElementById('appClientName').value.trim();
        const client_phone = document.getElementById('appClientPhone').value.trim();
        const date = document.getElementById('appDate').value;
        const time = document.getElementById('appTime').value;
        const note = document.getElementById('appNote').value.trim();

        const row = {
          type: 'appointment',
          broker_id: currentBroker?.email || currentBroker?.id || '',
          client_name, client_phone, date, time, note
        };
        try {
          await sheetPost(row);
          showAlert('Agendamento criado.');
          closeModal();
          await loadAll();
        } catch (err) {
          console.error(err);
          showAlert('Erro ao criar agendamento', 'error');
        }
      });
    }

    async function cancelAppointment(id) {
      if (!confirm('Deseja cancelar este agendamento?')) return;
      showAlert('Cancelamento por API não implementado automaticamente. Posso implementar se fornecer permissão para exclusão via API.');
    }

    async function handleBlockTime(e) {
      e.preventDefault();
      const date = document.getElementById('blockDate').value;
      const time = document.getElementById('blockTime').value;
      const reason = document.getElementById('blockReason').value.trim();
      if (!date || !time) return showAlert('Data e hora são obrigatórios', 'error');

      const row = {
        type: 'appointment',
        broker_id: currentBroker?.email || currentBroker?.id || '',
        client_name: 'BLOQUEIO PESSOAL',
        client_phone: '',
        date, time, note: 'Bloqueio: ' + reason
      };
      try {
        await sheetPost(row);
        showAlert('Horário bloqueado.');
        document.getElementById('blockTimeForm').reset();
        await loadAll();
      } catch (err) {
        console.error(err);
        showAlert('Erro ao bloquear horário', 'error');
      }
    }

    // ----------------------
    // CLIENT VIEW
    // ----------------------
    function renderClientProperties() {
      const wrap = document.getElementById('clientProperties');
      wrap.innerHTML = '';
      if (!properties.length) {
        wrap.innerHTML = '<div class="text-slate-500">Nenhum imóvel disponível.</div>';
        return;
      }
      properties.forEach(p => {
        const imgs = tryParseJSON(p.images) || (p.images ? p.images.split(',').map(s=>s.trim()) : []);
        const thumb = imgs[0] || '';
        const card = document.createElement('div');
        card.className = 'p-3 bg-white rounded shadow';
        card.innerHTML = `
          <div class="h-40 mb-3 rounded overflow-hidden bg-slate-100">${thumb ? `<img src="${thumb}" class="object-cover w-full h-full" />` : `<div class="flex items-center justify-center h-full text-slate-400">Sem imagem</div>`}</div>
          <div class="font-semibold">${p.title || '—'}</div>
          <div class="text-sm text-slate-500 mb-3">${p.address || p.description || ''}</div>
          <div class="flex items-center justify-between gap-2">
            <div class="font-medium">${p.price ? 'R$ ' + p.price : ''}</div>
            <div>
              <button class="px-2 py-1 bg-indigo-600 text-white rounded" onclick='openClientProperty("${encodeURIComponent(JSON.stringify(p))}")'>Ver</button>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      });
    }

    window.openClientProperty = function(propEncoded) {
      const p = JSON.parse(decodeURIComponent(propEncoded));
      const imgs = tryParseJSON(p.images) || (p.images ? p.images.split(',').map(s=>s.trim()) : []);
      const gallery = imgs.length ? imgs.map(u => `<img src="${u}" class="w-full h-48 object-cover rounded mb-2" />`).join('') : '<div class="text-slate-400">Sem imagens</div>';
      const html = `
        <div>
          ${gallery}
          <h3 class="font-semibold">${p.title || ''}</h3>
          <p class="text-sm text-slate-600">${p.description || ''}</p>
          <p class="mt-2 font-medium">${p.price ? 'R$ ' + p.price : ''}</p>
          <div class="mt-3 text-right">
            <button class="px-3 py-1 bg-green-600 text-white rounded" onclick='openBookingModal("${encodeURIComponent(JSON.stringify(p))}")'>Agendar visita</button>
          </div>
        </div>
      `;
      openModal(html);
    };

    window.openBookingModal = function(propEncoded) {
      const p = JSON.parse(decodeURIComponent(propEncoded));
      const html = `
        <h3 class="font-semibold mb-2">Agendar visita: ${p.title || ''}</h3>
        <form id="bookingForm" class="space-y-2">
          <input id="bookName" type="text" placeholder="Seu nome" class="w-full p-2 border rounded" required />
          <input id="bookPhone" type="text" placeholder="Telefone/WhatsApp" class="w-full p-2 border rounded" />
          <input id="bookDate" type="date" class="w-full p-2 border rounded" required />
          <input id="bookTime" type="time" class="w-full p-2 border rounded" required />
          <textarea id="bookNote" placeholder="Mensagem (opcional)" class="w-full p-2 border rounded"></textarea>
          <div class="text-right"><button class="px-3 py-1 bg-green-600 text-white rounded">Enviar pedido</button></div>
        </form>
      `;
      closeModal();
      openModal(html);

      document.getElementById('bookingForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const client_name = document.getElementById('bookName').value.trim();
        const client_phone = document.getElementById('bookPhone').value.trim();
        const date = document.getElementById('bookDate').value;
        const time = document.getElementById('bookTime').value;
        const note = document.getElementById('bookNote').value.trim();
        const row = {
          type: 'appointment',
          broker_id: p.broker_id || p.owner || '',
          client_name, client_phone, date, time, note, property_id: p.id || p._row || ''
        };
        try {
          await sheetPost(row);
          showAlert('Pedido de visita enviado. O corretor será notificado (se você tiver notificação configurada).');
          closeModal();
          await loadAll();
        } catch (err) {
          console.error(err);
          showAlert('Erro ao enviar pedido', 'error');
        }
      });
    };

    // ----------------------
    // IMGBB UPLOAD
    // ----------------------
    async function uploadToImgbb(file) {
      // file é um File object
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function() {
          const base64 = reader.result.split(',')[1];
          try {
            const res = await fetch('https://api.imgbb.com/1/upload?key=' + imgbbApiKey, {
              method: 'POST',
              body: new URLSearchParams({image: base64})
            });
            const json = await res.json();
            if (json && json.data && json.data.url) resolve(json.data.url);
            else reject('Upload falhou');
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(file);
      });
    }

    // ----------------------
    // Helpers
    // ----------------------
    function tryParseJSON(text) {
      if (!text) return null;
      try {
        return JSON.parse(text);
      } catch (err) {
        return null;
      }
    }

    // Expor algumas funções para acesso por botões inline (usado acima)
    window.openPropertyModal = openPropertyModal;
    window.openBookingModal = openBookingModal;
    window.deleteProperty = deleteProperty;
    window.cancelAppointment = cancelAppointment;

    // Recupera login salvo (se houver)
    (function restoreLogin() {
      const saved = localStorage.getItem('broker');
      if (saved) {
        try { currentBroker = JSON.parse(saved); } catch(e){ currentBroker = null; }
      }
    })();

  </script>
</body>
</html>
